# Milestone v3.0: User Access Control

**Status:** SHIPPED 2026-01-22
**Phases:** 15-17
**Total Plans:** 3

## Overview

Multi-user authentication with admin-controlled app lock and per-user cloud storage folders.

## Phases

### Phase 15: Multi-User Auth

**Goal:** Replace single shared password with multi-user system supporting user identity (id, name, password, isAdmin role)
**Depends on:** Previous milestone complete
**Plans:** 1 plan

Plans:
- [x] 15-01: Multi-user auth system

**Details:**
- Created User interface with id, name, password, isAdmin fields
- Updated useAuth hook to parse VITE_USERS JSON array and find matching user by password
- Updated PasswordGate to work with User | null return type
- Added user name and admin badge display in App header
- Backward compatible with single VITE_APP_PASSWORD config

### Phase 16: Admin App Lock

**Goal:** Add Cloudflare KV-based global lock that admin can toggle to block all non-admin users
**Depends on:** Phase 15
**Plans:** 1 plan

Plans:
- [x] 16-01: Admin app lock with KV storage

**Details:**
- Created GET/POST /api/app-lock endpoint using Cloudflare KV
- Created useAppLock hook with 30-second polling for state sync
- Added lock toggle button in header (admin only)
- Added locked screen for non-admin users when app is locked
- Admins immune to lock and always see full app

### Phase 17: User Cloud Folders

**Goal:** Add userId prefix to all cloud upload paths for per-user organization in R2
**Depends on:** Phase 16
**Plans:** 1 plan

Plans:
- [x] 17-01: Add userId prefix to cloud upload paths

**Details:**
- Added userId parameter to uploadChunk function for per-user folder paths
- Updated useContinuousRecording hook to accept and thread userId
- Connected CameraPreview to useAuth to pass user.id to continuous recording
- Cloud uploads now organized as `formcheck/{userId}/{date}/{sessionId}/chunk-XXXX.webm`

---

## Milestone Summary

**Key Decisions:**
- Store full User object in localStorage for session persistence
- Fallback to VITE_APP_PASSWORD for backward compatibility with default admin user
- Use Cloudflare KV for global lock state persistence
- Poll every 30 seconds to sync lock state across clients
- Admins immune to lock - always see full app
- Backward compatible uploadChunk works without userId for edge cases

**Issues Resolved:**
- None - all plans executed as designed

**Issues Deferred:**
- Admin user management UI (create/edit/delete users via UI instead of env vars)
- Cloud storage browsing by user folders

**Technical Debt Incurred:**
- User configuration via env vars requires redeployment to change users
- KV namespace requires manual Cloudflare setup before deployment

---

_For current project status, see .planning/ROADMAP.md_
