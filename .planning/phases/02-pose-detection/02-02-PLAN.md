---
phase: 02-pose-detection
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/hooks/usePostureAlerts.ts, src/utils/postureRules.ts, src/components/AlertOverlay.tsx, src/components/CameraPreview.tsx]
autonomous: true
---

<objective>
Implement general posture detection and audio/visual alerts for obviously wrong positions.

Purpose: Provide real-time feedback when user's posture is clearly incorrect (bent over, twisted, falling out of frame).
Output: Visual alert overlay and audio beep when bad posture detected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pose-detection/02-01-SUMMARY.md

@src/hooks/usePoseDetection.ts
@src/types/pose.ts
@src/components/CameraPreview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create posture analysis utilities</name>
  <files>src/utils/postureRules.ts</files>
  <action>
    Create utility functions for posture analysis:

    1. `calculateAngle(p1: Landmark, p2: Landmark, p3: Landmark): number`
       - Calculate angle at p2 between p1-p2-p3
       - Use atan2 for accurate angle calculation
       - Return degrees (0-180)

    2. `isLandmarkVisible(landmark: Landmark, threshold = 0.5): boolean`
       - Check if landmark.visibility >= threshold

    3. `checkGeneralPosture(landmarks: Landmark[]): PostureAlert | null`
       - Return null if posture is acceptable
       - Return PostureAlert if issues detected:

       **Detection rules:**
       a) **Shoulders uneven**: If |leftShoulder.y - rightShoulder.y| > 0.1 (normalized)
          → Alert: "Shoulders uneven - stand straight"

       b) **Leaning too far forward/back**: If nose.z significantly different from shoulder midpoint z
          → Alert: "Leaning too far - center yourself"

       c) **Body twisted**: If shoulder line and hip line angles differ significantly (>20°)
          → Alert: "Body twisted - face the camera"

       d) **Key landmarks missing**: If shoulders or hips not visible
          → Alert: "Step back - full body not visible"

    4. `PostureAlert` type: { type: string, message: string, severity: 'warning' | 'error' }

    Keep thresholds lenient for general posture - specific exercise form (Phase 4) will be stricter.
  </action>
  <verify>TypeScript compiles, utility functions exported</verify>
  <done>Posture analysis utilities calculate angles and detect general posture issues</done>
</task>

<task type="auto">
  <name>Task 2: Create usePostureAlerts hook with audio feedback</name>
  <files>src/hooks/usePostureAlerts.ts</files>
  <action>
    Create custom hook that:
    1. Accepts landmarks array from usePoseDetection
    2. Runs checkGeneralPosture on each landmarks update
    3. Manages alert state with debouncing:
       - Only trigger alert if bad posture persists for 500ms (avoid flicker)
       - Clear alert immediately when posture corrects
    4. Provides audio feedback:
       - Use Web Audio API to generate short beep (440Hz, 100ms) on new alert
       - Throttle audio to max once per 2 seconds (avoid annoying rapid beeps)
       - Create audio context on first user interaction (Chrome autoplay policy)
    5. Returns: { currentAlert: PostureAlert | null, playAlertSound: () => void }

    Audio implementation:
    - Create AudioContext lazily (on first alert)
    - Generate beep with OscillatorNode: type='sine', frequency=440Hz
    - Connect to gain node for volume control (0.3 volume)
    - Auto-stop after 100ms
  </action>
  <verify>Hook compiles, returns alert state</verify>
  <done>usePostureAlerts detects bad posture and provides audio/visual feedback</done>
</task>

<task type="auto">
  <name>Task 3: Create AlertOverlay component and integrate into CameraPreview</name>
  <files>src/components/AlertOverlay.tsx, src/components/CameraPreview.tsx</files>
  <action>
    Create AlertOverlay component:
    1. Accepts alert: PostureAlert | null prop
    2. When alert present, render overlay with:
       - Semi-transparent red border around video (warning indicator)
       - Alert message displayed at top of frame
       - Pulse animation on border for attention
    3. When no alert, render nothing (null)
    4. Use Tailwind for styling:
       - `border-4 border-red-500 animate-pulse` for warning border
       - Dark semi-transparent background for message readability
       - Position absolute, covering entire video area

    Update CameraPreview:
    1. Import and use usePostureAlerts hook
    2. Pass landmarks from usePoseDetection to usePostureAlerts
    3. Render AlertOverlay component with currentAlert
    4. Position AlertOverlay in the same container as video and PoseCanvas

    Component stack (bottom to top):
    - Video element
    - PoseCanvas (skeleton)
    - AlertOverlay (warning border + message)
  </action>
  <verify>npm run dev shows red border and message when posture is bad, clears when corrected</verify>
  <done>Visual alerts display during bad posture, audio beep plays on detection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Red border appears when leaning/twisting significantly
- [ ] Alert message is readable at top of video
- [ ] Audio beep plays on first detection (after user interaction)
- [ ] Alert clears when posture corrects
- [ ] No false positives during normal standing
- [ ] Works on mobile and desktop
</verification>

<success_criteria>
- All tasks completed
- General posture issues detected (uneven, leaning, twisted, out of frame)
- Visual alert overlay displays during bad posture
- Audio feedback provides additional cue
- Satisfies POSE-02: System detects obviously wrong postures
- Satisfies CAM-04: Audio/visual cue on bad form
</success_criteria>

<output>
After completion, create `.planning/phases/02-pose-detection/02-02-SUMMARY.md`
</output>
