---
phase: 04-exercise-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/utils/squatRules.ts, src/hooks/useExerciseAlerts.ts, src/components/CameraPreview.tsx]
autonomous: true
---

<objective>
Implement squat form detection with real-time alerts for knee angle, back position, and squat depth.

Purpose: Help users maintain proper squat form by detecting common issues (knees caving in, leaning too far forward, insufficient depth) and providing immediate feedback.
Output: Working squat form detection integrated into the camera preview with visual and audio alerts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 established the alert infrastructure we'll build on:
@.planning/phases/02-pose-detection/02-02-SUMMARY.md

# Existing code to understand and extend:
@src/types/pose.ts
@src/utils/postureRules.ts
@src/hooks/usePostureAlerts.ts
@src/components/CameraPreview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create squat form analysis utilities</name>
  <files>src/utils/squatRules.ts</files>
  <action>
Create squatRules.ts with squat-specific form detection:

1. Import Landmark type and relevant landmark constants (LEFT_HIP, RIGHT_HIP, LEFT_KNEE, RIGHT_KNEE, LEFT_ANKLE, RIGHT_ANKLE, LEFT_SHOULDER, RIGHT_SHOULDER)

2. Define squat thresholds:
   - SQUAT_DEPTH_THRESHOLD: 100 degrees (knee angle should be < 100 at proper depth)
   - SQUAT_KNEE_CAVE_THRESHOLD: 0.05 (normalized X - knees shouldn't move inward past ankle line)
   - SQUAT_FORWARD_LEAN_THRESHOLD: 45 degrees (torso angle from vertical)

3. Create SquatFormAlert interface extending the pattern from PostureAlert:
   - type: 'squat-depth' | 'squat-knee-cave' | 'squat-forward-lean' | 'squat-asymmetric'
   - message: string
   - severity: 'warning' | 'error'

4. Create helper functions:
   - getKneeAngle(landmarks): Calculate angle at knee (hip-knee-ankle)
   - getTorsoAngle(landmarks): Calculate torso angle from vertical (hip-shoulder line vs vertical)
   - isSquatPosition(landmarks): Detect if user is in squat stance (both knees bent below threshold ~150 degrees)

5. Create checkSquatForm(landmarks): SquatFormAlert | null
   - First check isSquatPosition() - return null if not squatting (don't alert when standing)
   - Check depth: if knee angle > SQUAT_DEPTH_THRESHOLD, return depth warning
   - Check knee cave: if knees X position is significantly inside ankle X, return knee cave warning
   - Check forward lean: if torso angle > SQUAT_FORWARD_LEAN_THRESHOLD, return lean warning
   - Check asymmetry: if left/right knee angles differ by > 15 degrees, return asymmetric warning
   - Return null if form is good

Use existing calculateAngle and isLandmarkVisible from postureRules.ts.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>squatRules.ts exports checkSquatForm and isSquatPosition functions</done>
</task>

<task type="auto">
  <name>Task 2: Create exercise-specific alerts hook</name>
  <files>src/hooks/useExerciseAlerts.ts</files>
  <action>
Create useExerciseAlerts hook that extends the pattern from usePostureAlerts:

1. Import checkSquatForm and isSquatPosition from squatRules.ts
2. Import checkGeneralPosture from postureRules.ts (for fallback when not exercising)

3. Create ExerciseMode type: 'general' | 'squat' | 'pushup' (pushup for Plan 02)

4. Create useExerciseAlerts hook:
   - Parameters: landmarks: Landmark[] | null, mode: ExerciseMode
   - Uses same debounce pattern as usePostureAlerts (500ms)
   - Uses same audio pattern (2s throttle, 440Hz beep)

5. Logic flow:
   - If mode === 'general': use checkGeneralPosture (existing behavior)
   - If mode === 'squat':
     - First check if in squat position with isSquatPosition
     - If in squat: use checkSquatForm
     - If standing: use checkGeneralPosture (monitor general posture between reps)
   - If mode === 'pushup': placeholder for Plan 02 (use checkGeneralPosture for now)

6. Return same interface as usePostureAlerts:
   - currentAlert: PostureAlert | SquatFormAlert | null
   - playAlertSound: () => void
   - Plus: isExercising: boolean (true when in detected exercise position)

This hook will REPLACE usePostureAlerts usage in CameraPreview - it's a superset that includes general posture checking.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>useExerciseAlerts hook exports with mode parameter for squat detection</done>
</task>

<task type="auto">
  <name>Task 3: Integrate squat detection into CameraPreview</name>
  <files>src/components/CameraPreview.tsx</files>
  <action>
Update CameraPreview to use the new exercise alerts system:

1. Replace usePostureAlerts import with useExerciseAlerts
2. Add exercise mode state: const [exerciseMode, setExerciseMode] = useState<ExerciseMode>('general')
3. Update hook usage: const { currentAlert, isExercising } = useExerciseAlerts(landmarks, exerciseMode)

4. Add exercise mode selector UI (positioned top-right, below detection indicator):
   - Simple toggle/dropdown: General | Squat | Push-up
   - Style consistent with existing status indicator (rounded pill, semi-transparent background)
   - Make Push-up option disabled until Plan 02 implements it

5. Optionally show "Squat detected" indicator when isExercising is true in squat mode
   - Brief visual cue that the system recognized the exercise position

Keep all existing functionality (skeleton overlay, recording controls, camera switch).
  </action>
  <verify>npm run build succeeds; app runs and shows exercise mode selector</verify>
  <done>CameraPreview has exercise mode selector; squat mode triggers squat-specific alerts when user squats</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] App loads and shows exercise mode selector
- [ ] Selecting "Squat" mode doesn't break existing functionality
- [ ] When in squat mode, doing a squat triggers form analysis (not general posture)
</verification>

<success_criteria>

- All tasks completed
- Squat form detection works in real-time
- Exercise mode selector visible and functional
- Existing general posture alerts still work in "General" mode
- No TypeScript errors or build failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-exercise-alerts/04-01-SUMMARY.md`
</output>
