---
phase: 04-exercise-alerts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/utils/pushupRules.ts, src/hooks/useExerciseAlerts.ts, src/components/CameraPreview.tsx]
autonomous: true
---

<objective>
Implement push-up form detection with real-time alerts for body alignment, elbow angle, and depth.

Purpose: Help users maintain proper push-up form by detecting common issues (sagging hips, flared elbows, insufficient depth) and providing immediate feedback.
Output: Working push-up form detection integrated into the camera preview with visual and audio alerts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 established the alert infrastructure:
@.planning/phases/02-pose-detection/02-02-SUMMARY.md

# Plan 04-01 creates the exercise alerts hook we'll extend:
# NOTE: If running in parallel with 04-01, both plans modify useExerciseAlerts.ts
# Wave 1 parallel execution means executor will handle merge if needed

# Existing code to understand and extend:
@src/types/pose.ts
@src/utils/postureRules.ts
@src/hooks/usePostureAlerts.ts
@src/components/CameraPreview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create push-up form analysis utilities</name>
  <files>src/utils/pushupRules.ts</files>
  <action>
Create pushupRules.ts with push-up-specific form detection:

1. Import Landmark type and relevant landmark constants (LEFT_SHOULDER, RIGHT_SHOULDER, LEFT_ELBOW, RIGHT_ELBOW, LEFT_WRIST, RIGHT_WRIST, LEFT_HIP, RIGHT_HIP, LEFT_ANKLE, RIGHT_ANKLE)

2. Define push-up thresholds:
   - PUSHUP_DEPTH_THRESHOLD: 100 degrees (elbow angle should be < 100 at proper depth)
   - PUSHUP_HIP_SAG_THRESHOLD: 15 degrees (angle deviation of hip from shoulder-ankle line)
   - PUSHUP_HIP_PIKE_THRESHOLD: 15 degrees (hips too high - piking up)
   - PUSHUP_ELBOW_FLARE_THRESHOLD: 75 degrees (elbow angle relative to torso - should stay tucked)

3. Create PushupFormAlert interface:
   - type: 'pushup-depth' | 'pushup-hip-sag' | 'pushup-hip-pike' | 'pushup-elbow-flare'
   - message: string
   - severity: 'warning' | 'error'

4. Create helper functions:
   - getElbowAngle(landmarks): Calculate angle at elbow (shoulder-elbow-wrist)
   - getBodyLineAngle(landmarks): Calculate deviation of hip from shoulder-ankle line
   - isPushupPosition(landmarks): Detect if user is in push-up stance:
     - Horizontal body orientation (shoulders and hips at similar Y level)
     - Hands below shoulders (wrists near shoulder X but lower Y)
     - Body roughly horizontal (not standing/sitting)

5. Create checkPushupForm(landmarks): PushupFormAlert | null
   - First check isPushupPosition() - return null if not in push-up position
   - Check hip sag: if hip drops below shoulder-ankle line, return sag warning
   - Check hip pike: if hip rises above shoulder-ankle line, return pike warning
   - Check depth: if elbow angle > PUSHUP_DEPTH_THRESHOLD at bottom position, return depth warning
   - Check elbow flare: if elbows are too far from body, return flare warning
   - Return null if form is good

Use existing calculateAngle and isLandmarkVisible from postureRules.ts.

NOTE: Push-up detection works best from side view (sagittal plane) for body line, but elbow position is better from behind. Document this in code comments - user should position camera to side for best results.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>pushupRules.ts exports checkPushupForm and isPushupPosition functions</done>
</task>

<task type="auto">
  <name>Task 2: Extend useExerciseAlerts for push-up mode</name>
  <files>src/hooks/useExerciseAlerts.ts</files>
  <action>
Extend the useExerciseAlerts hook to support push-up mode:

1. Import checkPushupForm and isPushupPosition from pushupRules.ts

2. Update the ExerciseMode type if not already: 'general' | 'squat' | 'pushup'

3. Add push-up logic to the mode switch:
   - If mode === 'pushup':
     - Check if in push-up position with isPushupPosition
     - If in push-up: use checkPushupForm
     - If not in position: use checkGeneralPosture (monitor posture between reps)

4. Union the alert types in the return type:
   - currentAlert: PostureAlert | SquatFormAlert | PushupFormAlert | null

NOTE: If Plan 04-01 hasn't run yet, you'll need to create the full useExerciseAlerts hook structure including squat support. If 04-01 has run, just add the push-up case to the existing switch.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>useExerciseAlerts hook handles 'pushup' mode with form detection</done>
</task>

<task type="auto">
  <name>Task 3: Enable push-up mode in CameraPreview</name>
  <files>src/components/CameraPreview.tsx</files>
  <action>
Enable the push-up option in the exercise mode selector:

1. If the exercise mode selector already exists from Plan 04-01:
   - Remove disabled state from Push-up option
   - Ensure selecting Push-up mode works

2. If Plan 04-01 hasn't run yet (you're implementing first):
   - Add the full exercise mode selector UI as described in 04-01
   - Include all three modes: General | Squat | Push-up
   - Position top-right, below detection indicator
   - Style: rounded pill, semi-transparent background

3. Add helper text/tooltip for push-up mode:
   - "Best results from side view" - brief note about camera positioning
   - Can be a small info icon or text under the selector

4. When push-up mode is active and isExercising is true:
   - Show "Push-up detected" indicator (similar pattern to squat detection)
  </action>
  <verify>npm run build succeeds; push-up mode selectable and functional</verify>
  <done>Push-up mode enabled in selector; form detection triggers when user does push-ups</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] Push-up mode is selectable in exercise mode dropdown
- [ ] General and Squat modes still work (no regressions)
- [ ] When in push-up mode, being in push-up position triggers form analysis
</verification>

<success_criteria>

- All tasks completed
- Push-up form detection works in real-time
- All three exercise modes functional (General, Squat, Push-up)
- Camera positioning guidance visible for push-up mode
- No TypeScript errors or build failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-exercise-alerts/04-02-SUMMARY.md`
</output>
