---
phase: 06-s3-upload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/types/s3.ts, src/utils/s3Upload.ts, src/hooks/useS3Upload.ts]
autonomous: true
user_setup:
  - service: aws-s3
    why: "User provides their own S3 bucket for cloud backup"
    env_vars: []
    account_setup:
      - url: "https://aws.amazon.com/console/"
        skip_if: "Already have AWS account with S3 bucket"
    dashboard_config:
      - task: "Create S3 bucket with public write access"
        location: "AWS Console → S3 → Create bucket"
        details: "Enable public access, add CORS policy allowing PUT from app domain"
      - task: "Configure CORS policy"
        location: "Bucket → Permissions → CORS"
        details: |
          [
            {
              "AllowedHeaders": ["*"],
              "AllowedMethods": ["PUT"],
              "AllowedOrigins": ["*"],
              "ExposeHeaders": ["ETag"]
            }
          ]
    local_dev: []
---

<objective>
Create S3 upload foundation with types, upload service, and React hook.

Purpose: Enable browser-direct uploads to user-configured S3 bucket with progress tracking and retry logic.
Output: S3 types, upload utility with retry, useS3Upload hook for state management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/types/recording.ts
@src/hooks/useRecordingHistory.ts
@src/utils/recordingStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create S3 config types and upload utility</name>
  <files>src/types/s3.ts, src/utils/s3Upload.ts</files>
  <action>
1. Create `src/types/s3.ts` with:
   - `S3Config` interface: bucket, region, accessKeyId, secretAccessKey
   - `UploadProgress` interface: loaded, total, percentage
   - `UploadStatus` type: 'pending' | 'uploading' | 'complete' | 'failed'
   - `UploadResult` interface: success, url (or error message)

2. Create `src/utils/s3Upload.ts` with:
   - `saveS3Config(config: S3Config)` - saves to localStorage
   - `getS3Config(): S3Config | null` - retrieves from localStorage
   - `uploadToS3(blob: Blob, fileName: string, config: S3Config, onProgress?: (progress: UploadProgress) => void): Promise<UploadResult>`

For uploadToS3:
- Use XMLHttpRequest for progress events (not fetch - no progress support)
- Construct S3 PUT URL: `https://${config.bucket}.s3.${config.region}.amazonaws.com/${fileName}`
- Set Content-Type from blob.type
- Implement retry logic: 3 attempts with exponential backoff (1s, 2s, 4s delays)
- On success, return { success: true, url: objectUrl }
- On failure after retries, return { success: false, error: message }

NOTE: Use XMLHttpRequest instead of AWS SDK v3 - simpler for public bucket PUT, no additional dependency, native progress events. The bucket is configured for public anonymous writes via CORS.
  </action>
  <verify>npm run build passes with no TypeScript errors</verify>
  <done>S3 types exported, upload utility with retry logic works</done>
</task>

<task type="auto">
  <name>Task 2: Create useS3Upload hook with queue management</name>
  <files>src/hooks/useS3Upload.ts</files>
  <action>
Create `src/hooks/useS3Upload.ts` with:

```typescript
interface UploadItem {
  id: number;           // Recording id from IndexedDB
  status: UploadStatus;
  progress: UploadProgress;
  error?: string;
}

interface UseS3UploadReturn {
  config: S3Config | null;
  isConfigured: boolean;
  saveConfig: (config: S3Config) => void;
  clearConfig: () => void;
  uploads: UploadItem[];
  uploadRecording: (recording: StoredRecording) => Promise<void>;
  retryUpload: (id: number, recording: StoredRecording) => Promise<void>;
  isUploading: boolean;
}
```

Implementation:
- Load config from localStorage on mount using getS3Config()
- `saveConfig` stores via saveS3Config() and updates state
- `clearConfig` removes from localStorage
- Track uploads in state array by recording id
- `uploadRecording` adds to uploads array as 'pending', then calls uploadToS3
- Update progress via onProgress callback
- On complete, update status to 'complete' or 'failed'
- `retryUpload` resets status to 'pending' and retries
- `isUploading` is true if any upload has status 'uploading'

Generate unique fileName as: `formcheck-${recording.id}-${recording.timestamp.getTime()}.webm`
  </action>
  <verify>npm run build passes with no TypeScript errors</verify>
  <done>useS3Upload hook exports correctly, manages upload state</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (or only has pre-existing warnings)
- [ ] S3Config can be saved/loaded from localStorage
- [ ] Upload function signature supports progress callbacks
- [ ] Retry logic implemented with exponential backoff
</verification>

<success_criteria>

- All tasks completed
- Types properly exported from src/types/s3.ts
- Upload utility handles retries and progress
- Hook manages config and upload state
- No new TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/06-s3-upload/06-01-SUMMARY.md`
</output>
