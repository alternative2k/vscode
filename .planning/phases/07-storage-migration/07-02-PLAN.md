---
phase: 07-storage-migration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/utils/cloudUpload.ts
  - src/hooks/useCloudUpload.ts
autonomous: true
---

<objective>
Create the frontend upload infrastructure that uses presigned URLs from the Pages Function.

Purpose: Replace the credential-exposing S3 upload pattern with secure presigned URL uploads. The upload utility fetches a URL from `/api/upload-url`, then uploads directly to R2.

Output: cloudUpload.ts utility and useCloudUpload.ts hook ready for UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-storage-migration/07-RESEARCH.md
@.planning/phases/07-storage-migration/07-01-SUMMARY.md

# Existing implementations to mirror patterns from:
@src/utils/s3Upload.ts
@src/hooks/useS3Upload.ts
@src/types/cloud.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cloudUpload utility</name>
  <files>src/utils/cloudUpload.ts</files>
  <action>
Create upload utility that uses presigned URLs instead of direct credentials.

Key differences from s3Upload.ts:
- NO credentials stored or passed
- Two-step upload: (1) fetch presigned URL, (2) upload to that URL
- Config storage is just `{ enabled: boolean }` - not credentials

Functions to implement:
1. `saveCloudConfig(config: CloudConfig)` - save to localStorage
2. `getCloudConfig(): CloudConfig | null` - retrieve from localStorage
3. `clearCloudConfig()` - remove from localStorage
4. `uploadToCloud(blob, fileName, onProgress?)` - main upload function

Upload flow in `uploadToCloud`:
```typescript
// 1. Get presigned URL from Pages Function
const response = await fetch('/api/upload-url', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ fileName, contentType: blob.type || 'video/webm' })
});
const { uploadUrl, objectKey } = await response.json();

// 2. Upload to R2 using existing XHR pattern (for progress tracking)
return attemptUpload(blob, uploadUrl, onProgress);
```

REUSE the `attemptUpload` and `delay` functions from s3Upload.ts - the XHR upload with progress tracking and retry logic is solid. The only change is: instead of constructing S3 URL with credentials, we use the presigned URL.

localStorage key: `formcheck-cloud-config` (different from s3 key to avoid conflicts during transition)
  </action>
  <verify>tsc --noEmit passes, cloudUpload.ts exports all 4 functions</verify>
  <done>
- cloudUpload.ts created with all functions
- Uses presigned URL flow (fetch from /api/upload-url, then PUT)
- Reuses XHR progress tracking pattern
- No credentials in code or storage
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useCloudUpload hook</name>
  <files>src/hooks/useCloudUpload.ts</files>
  <action>
Create React hook that mirrors useS3Upload.ts but simplified (no credentials state).

Key differences from useS3Upload.ts:
- Config is just `{ enabled: boolean }` instead of bucket/region/keys
- `saveConfig` and `clearConfig` toggle enabled state
- No credential validation needed
- Otherwise same upload/retry/progress tracking logic

Interface to implement:
```typescript
export interface UseCloudUploadReturn {
  config: CloudConfig | null;
  isConfigured: boolean;  // config?.enabled === true
  enableCloud: () => void;  // sets { enabled: true }
  disableCloud: () => void;  // clears config
  uploads: UploadItem[];
  uploadRecording: (recording: StoredRecording) => Promise<void>;
  retryUpload: (id: number, recording: StoredRecording) => Promise<void>;
  isUploading: boolean;
}
```

UploadItem type (same as useS3Upload):
```typescript
export interface UploadItem {
  id: number;
  status: UploadStatus;
  progress: UploadProgress;
  error?: string;
}
```

File name generation: same pattern `formcheck-{id}-{timestamp}.webm`

The hook manages upload state (uploads array, progress updates) exactly like useS3Upload. The only simplification is config handling.
  </action>
  <verify>tsc --noEmit passes, hook exports UseCloudUploadReturn interface</verify>
  <done>
- useCloudUpload.ts created with full hook implementation
- Exports UploadItem interface and UseCloudUploadReturn interface
- Uses cloudUpload.ts utilities
- Same upload/retry/progress pattern as useS3Upload
- Simplified config (just enabled boolean)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `tsc --noEmit` passes
- [ ] src/utils/cloudUpload.ts exports saveCloudConfig, getCloudConfig, clearCloudConfig, uploadToCloud
- [ ] src/hooks/useCloudUpload.ts exports useCloudUpload hook
- [ ] No credentials stored anywhere in the new code
</verification>

<success_criteria>
- cloudUpload.ts utility created with presigned URL flow
- useCloudUpload.ts hook created with same UX as useS3Upload
- All TypeScript compiles without errors
- Ready for UI integration in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/07-storage-migration/07-02-SUMMARY.md`
</output>
