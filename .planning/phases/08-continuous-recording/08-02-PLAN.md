---
phase: 08-continuous-recording
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified: [src/hooks/useContinuousRecording.ts]
autonomous: true
---

<objective>
Create useContinuousRecording hook with visibilitychange handling.

Purpose: Background MediaRecorder that saves chunks to IndexedDB progressively and triggers uploads when user leaves page.
Output: useContinuousRecording hook ready for UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-continuous-recording/08-RESEARCH.md
@.planning/phases/08-continuous-recording/08-01-SUMMARY.md

# Existing patterns to follow:
@src/hooks/useRecording.ts
@src/hooks/useCloudUpload.ts
@src/utils/chunkStorage.ts
@src/utils/cloudUpload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useContinuousRecording hook</name>
  <files>src/hooks/useContinuousRecording.ts</files>
  <action>
Create hook following patterns from useRecording.ts and useCloudUpload.ts.

**Interface:**
```typescript
interface UseContinuousRecordingReturn {
  state: ContinuousRecordingState;
  isEnabled: boolean;
  sessionId: string | null;
  duration: number;
  chunkCount: number;
  uploadProgress: { uploaded: number; total: number };
  enable: () => void;
  disable: () => void;
  error: string | null;
}
```

**Key behaviors:**

1. **Auto-start on enable:** When enabled and stream available, starts MediaRecorder automatically.

2. **Progressive chunk saving:** On each ondataavailable (5000ms timeslice), save chunk to IndexedDB immediately using chunkStorage.saveChunk(). Do NOT accumulate in memory.

3. **Visibilitychange handling:**
   - On `hidden`: Stop recorder, save final chunk, trigger upload of all pending chunks for session
   - On `visible`: If enabled, start new session and resume recording
   - This is the ONLY reliable page exit signal - do NOT use beforeunload

4. **Upload integration:** Use existing uploadToCloud() from cloudUpload.ts. Upload chunks sequentially, mark as uploaded after success.

5. **Session management:**
   - Generate sessionId on start: `continuous-${Date.now()}`
   - Save session metadata via saveSession()
   - Update status as recording progresses

6. **Duration tracking:** Use Date.now() timer, NOT chunk count. Research shows timeslice is inexact.

7. **Cleanup on disable:** Stop recorder, upload pending chunks, mark session complete.

**Error handling:**
- MediaRecorder errors: Set error state, try to recover
- Upload failures: Keep chunks in IndexedDB for retry (don't delete until confirmed)
- Storage errors: Log and continue (graceful degradation)

**IMPORTANT:** Reuse getSupportedMimeType() pattern from useRecording.ts. Use 'video/webm;codecs=vp9' preference.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>useContinuousRecording hook created with all behaviors, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Add chunk upload function to cloudUpload.ts</name>
  <files>src/utils/cloudUpload.ts</files>
  <action>
Add a function to upload a chunk blob with session context in the filename:

```typescript
export async function uploadChunk(
  blob: Blob,
  sessionId: string,
  chunkIndex: number,
  onProgress?: (progress: UploadProgress) => void
): Promise<UploadResult> {
  const fileName = `${sessionId}/chunk-${String(chunkIndex).padStart(4, '0')}.webm`;
  return uploadToCloud(blob, fileName, onProgress);
}
```

This organizes chunks in folders by session ID on R2.
Add this after the existing uploadToCloud function.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>uploadChunk function added to cloudUpload.ts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npx tsc --noEmit passes
- [ ] Hook exports all interface members
- [ ] uploadChunk function works with existing uploadToCloud
- [ ] No lint errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Hook ready for UI integration in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/08-continuous-recording/08-02-SUMMARY.md`
</output>
