---
phase: 14-resilient-upload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/cloudUpload.ts
  - src/hooks/useContinuousRecording.ts
  - src/types/recording.ts
autonomous: true
---

<objective>
Add resilient upload handling with date-based folder organization and network reconnection retry.

Purpose: Ensure video chunks upload reliably even with intermittent network, and organize cloud storage by date for easier browsing.
Output: Uploads organized as `2026-01-21/session-abc/chunk-0001.webm`, automatic retry on network reconnect.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-auto-start-recording/12-01-SUMMARY.md

@src/utils/cloudUpload.ts
@src/hooks/useContinuousRecording.ts
@src/utils/chunkStorage.ts
@src/types/recording.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add date-based folder structure to upload path</name>
  <files>src/utils/cloudUpload.ts</files>
  <action>
Modify the `uploadChunk` function to include a date prefix in the upload path.

1. Create a helper function `getDateFolder()` that returns today's date as `YYYY-MM-DD`:
   ```typescript
   function getDateFolder(): string {
     const now = new Date();
     return now.toISOString().split('T')[0]; // Returns "2026-01-21"
   }
   ```

2. Update the fileName construction in `uploadChunk`:
   ```typescript
   const dateFolder = getDateFolder();
   const fileName = `${dateFolder}/${sessionId}/chunk-${String(chunkIndex).padStart(4, '0')}.webm`;
   ```

Result: Chunks upload to `2026-01-21/continuous-1737489600000/chunk-0001.webm`
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Upload paths include date prefix (YYYY-MM-DD/sessionId/chunk-NNNN.webm)</done>
</task>

<task type="auto">
  <name>Task 2: Add retry queue with exponential backoff in hook</name>
  <files>src/hooks/useContinuousRecording.ts, src/types/recording.ts</files>
  <action>
Add retry logic at the hook level to handle failed uploads with exponential backoff and network reconnection.

1. Add `retryCount` field to RecordingChunk type in `src/types/recording.ts`:
   ```typescript
   export interface RecordingChunk {
     // ... existing fields
     retryCount?: number;  // Number of upload attempts (max 5)
   }
   ```

2. In `useContinuousRecording.ts`, modify `uploadPendingChunks`:
   - Track retry count per chunk
   - If upload fails, increment retry count and save back to IndexedDB
   - Skip chunks that have exceeded max retries (5)
   - Log permanent failures for debugging

3. Add network reconnection listener to retry pending uploads:
   ```typescript
   useEffect(() => {
     const handleOnline = () => {
       // Network came back - retry any pending chunks
       if (sessionIdRef.current) {
         uploadPendingChunks(sessionIdRef.current);
       }
     };

     window.addEventListener('online', handleOnline);
     return () => window.removeEventListener('online', handleOnline);
   }, [uploadPendingChunks]);
   ```

4. Add periodic retry check for failed chunks (every 30 seconds when recording):
   - Only retry chunks with retryCount < 5
   - Use exponential backoff based on retryCount (delay = 2^retryCount seconds)
   - Don't retry if currently uploading
  </action>
  <verify>tsc --noEmit passes, npm run build succeeds</verify>
  <done>Failed uploads retry with exponential backoff, network reconnect triggers retry, max 5 attempts per chunk</done>
</task>

<task type="auto">
  <name>Task 3: Update status indicator to show retry state</name>
  <files>src/components/ContinuousRecordingStatus.tsx</files>
  <action>
Enhance the status indicator to show when uploads are being retried.

1. Add a new state display for "retrying":
   - When `state === 'uploading'` AND there are chunks with `retryCount > 0` in current upload batch
   - Show orange/amber dot (same as uploading) with "Retrying X/Y" text

2. This requires passing additional info from the hook. Modify the state to include a `hasRetries` boolean:
   - In useContinuousRecording, track if current upload batch contains any retries
   - Pass this through to the status component

The visual should be subtle - same uploading state but text changes from "Uploading X/Y" to "Retrying X/Y" when applicable.
  </action>
  <verify>npm run build succeeds, tsc --noEmit passes</verify>
  <done>Status indicator shows "Retrying X/Y" when re-uploading failed chunks</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` starts, camera loads, continuous recording activates
- [ ] Chunks upload to date-prefixed paths (check network tab: `/api/upload-url` payload includes date folder)
- [ ] Simulated offline/online cycle triggers retry (Network tab → Offline → Online)
- [ ] Status shows "Retrying" when re-uploading failed chunks
- [ ] No console errors
</verification>

<success_criteria>

- Date-based folder structure: `YYYY-MM-DD/sessionId/chunk-NNNN.webm`
- Network reconnect triggers pending chunk retry
- Exponential backoff on failed uploads (max 5 retries per chunk)
- Status indicator shows retry state
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-resilient-upload/14-01-SUMMARY.md`
</output>
