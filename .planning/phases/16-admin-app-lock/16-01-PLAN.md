---
phase: 16-admin-app-lock
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/api/app-lock.ts
  - src/hooks/useAppLock.ts
  - src/App.tsx
  - wrangler.toml
autonomous: true
user_setup:
  - service: cloudflare-kv
    why: "Store global app lock state"
    env_vars: []
    dashboard_config:
      - task: "Create KV namespace"
        location: "Cloudflare Dashboard → Workers & Pages → KV → Create a namespace"
        details: "Name: formcheck-settings (or similar). Copy the namespace ID."
      - task: "Bind KV to Pages project"
        location: "Cloudflare Dashboard → Workers & Pages → formcheck → Settings → Bindings → Add"
        details: "Variable name: SETTINGS_KV, KV namespace: formcheck-settings"
    local_dev:
      - "For local dev with wrangler pages dev, add [[kv_namespaces]] to wrangler.toml"
---

<objective>
Add admin-only app lock toggle using Cloudflare KV for global state persistence.

Purpose: Allow admin users to lock the app, blocking all non-admin users from accessing.
Output: Lock toggle button for admins, locked screen for non-admin users when locked.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-user-access-control/15-01-SUMMARY.md

@src/types/auth.ts
@src/hooks/useAuth.ts
@src/App.tsx
@functions/api/upload-url.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create app-lock API endpoint with KV storage</name>
  <files>functions/api/app-lock.ts, wrangler.toml</files>
  <action>
Create Cloudflare Pages Function at functions/api/app-lock.ts that:

1. Handles GET requests to check lock status:
   - Read "app_locked" key from KV (SETTINGS_KV binding)
   - Return { locked: boolean }
   - Default to false if key doesn't exist

2. Handles POST requests to toggle lock (admin only):
   - Accept { locked: boolean } in request body
   - Write to "app_locked" key in KV
   - Return { locked: boolean, success: true }

Interface Env should include:
- SETTINGS_KV: KVNamespace

Create wrangler.toml for local development:
```toml
name = "formcheck"
compatibility_date = "2024-01-01"

[[kv_namespaces]]
binding = "SETTINGS_KV"
id = "YOUR_KV_NAMESPACE_ID"
preview_id = "YOUR_KV_NAMESPACE_ID"
```

Note: The KV namespace ID will be filled in after user creates it in Cloudflare Dashboard.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit -p tsconfig.node.json (or equivalent for functions)</verify>
  <done>API endpoint exists at /api/app-lock with GET/POST handlers</done>
</task>

<task type="auto">
  <name>Task 2: Create useAppLock hook for frontend state</name>
  <files>src/hooks/useAppLock.ts</files>
  <action>
Create React hook that:

1. Fetches lock status on mount via GET /api/app-lock
2. Returns { isLocked: boolean, isLoading: boolean, toggleLock: () => Promise<void> }
3. toggleLock sends POST /api/app-lock with toggled state
4. Poll for lock status every 30 seconds (in case another admin changes it)
5. Handle errors gracefully - default to unlocked if API fails

The hook should be lightweight and not require the user object - that check happens in App.tsx.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>useAppLock hook exports isLocked, isLoading, toggleLock</done>
</task>

<task type="auto">
  <name>Task 3: Integrate lock into App with admin toggle and locked screen</name>
  <files>src/App.tsx</files>
  <action>
Update App.tsx to:

1. Import and use useAppLock hook
2. Add lock toggle button in header (only visible to admin users):
   - Show lock/unlock icon or text
   - Call toggleLock on click
   - Disable while loading

3. Show locked screen for non-admin users when app is locked:
   - Display "App Locked" message
   - Show "The app is currently locked by an administrator"
   - Still show logout button so user can log out
   - Check: if (isLocked && !user?.isAdmin) show locked screen

4. Admin users always see the full app even when locked (they're immune)

Keep the existing header layout, just add the lock toggle next to the user name/logout area.
  </action>
  <verify>npm run build succeeds; npm run dev starts without errors</verify>
  <done>Admin sees lock toggle; non-admin sees locked screen when locked; admin always has access</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] npm run dev starts the app
- [ ] wrangler.toml exists with KV namespace placeholder
- [ ] functions/api/app-lock.ts handles GET and POST
- [ ] useAppLock hook fetches and toggles lock state
- [ ] App.tsx shows lock toggle for admin, locked screen for non-admin when locked
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Admin can toggle lock
- Non-admin blocked when locked
- Admin immune to lock
</success_criteria>

<output>
After completion, create `.planning/phases/16-admin-app-lock/16-01-SUMMARY.md`
</output>
