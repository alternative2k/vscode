---
phase: 17-user-cloud-folders
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/utils/cloudUpload.ts, src/hooks/useContinuousRecording.ts, src/components/CameraPreview.tsx]
autonomous: true
---

<objective>
Add userId prefix to all cloud upload paths for per-user folder organization in R2.

Purpose: Each user's recordings are stored in their own folder, making it easy to browse and manage recordings by user.
Output: Cloud uploads organized as `formcheck/{userId}/{date}/{sessionId}/chunk-XXXX.webm`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-user-access-control/15-01-SUMMARY.md
@.planning/phases/16-admin-app-lock/16-01-SUMMARY.md

# Current upload path structure (cloudUpload.ts:68-70):
# const dateFolder = getDateFolder();
# const fileName = `${dateFolder}/${sessionId}/chunk-${String(chunkIndex).padStart(4, '0')}.webm`;
# Result: formcheck/2026-01-21/continuous-1234567/chunk-0001.webm

# Target structure:
# formcheck/{userId}/2026-01-21/continuous-1234567/chunk-0001.webm

# User object available from useAuth (Phase 15):
# user.id is the unique user identifier for folder paths

@src/utils/cloudUpload.ts
@src/hooks/useContinuousRecording.ts
@src/components/CameraPreview.tsx
@src/hooks/useAuth.ts
@src/types/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add userId parameter to uploadChunk function</name>
  <files>src/utils/cloudUpload.ts</files>
  <action>
Modify the `uploadChunk` function signature to accept an optional `userId` parameter.

Update the fileName construction to include userId as the first path segment:
- If userId provided: `${userId}/${dateFolder}/${sessionId}/chunk-XXX.webm`
- If userId not provided (backward compat): `${dateFolder}/${sessionId}/chunk-XXX.webm`

The function signature change:
```typescript
export async function uploadChunk(
  blob: Blob,
  sessionId: string,
  chunkIndex: number,
  userId?: string,  // Add optional userId parameter
  onProgress?: (progress: UploadProgress) => void
): Promise<UploadResult>
```

Inside the function, build the path:
```typescript
const dateFolder = getDateFolder();
const userPrefix = userId ? `${userId}/` : '';
const fileName = `${userPrefix}${dateFolder}/${sessionId}/chunk-${String(chunkIndex).padStart(4, '0')}.webm`;
```
  </action>
  <verify>TypeScript compiles: `npm run build` succeeds</verify>
  <done>uploadChunk accepts userId and includes it in the upload path when provided</done>
</task>

<task type="auto">
  <name>Task 2: Thread userId through useContinuousRecording hook</name>
  <files>src/hooks/useContinuousRecording.ts</files>
  <action>
Add userId to the hook's options interface and pass it through to uploadChunk calls.

1. Update UseContinuousRecordingOptions interface:
```typescript
interface UseContinuousRecordingOptions {
  autoStart?: boolean;
  userId?: string;  // Add userId for cloud folder organization
}
```

2. In uploadPendingChunks callback, pass userId to uploadChunk:
Find the line: `const result = await uploadChunk(chunk.blob, forSessionId, chunk.chunkIndex);`
Change to: `const result = await uploadChunk(chunk.blob, forSessionId, chunk.chunkIndex, options?.userId);`

Note: Need to capture options in a ref or pass userId through the callback dependency. Simplest approach: add userId to the useCallback dependency array and use it directly from options.
  </action>
  <verify>TypeScript compiles: `npm run build` succeeds</verify>
  <done>useContinuousRecording accepts userId option and passes it to uploadChunk</done>
</task>

<task type="auto">
  <name>Task 3: Pass user.id from CameraPreview to useContinuousRecording</name>
  <files>src/components/CameraPreview.tsx</files>
  <action>
Import useAuth and pass user.id to the useContinuousRecording hook.

1. Add import for useAuth:
```typescript
import { useAuth } from '../hooks/useAuth';
```

2. Inside CameraPreview component, call useAuth:
```typescript
const { user } = useAuth();
```

3. Update useContinuousRecording call to include userId:
Find: `useContinuousRecording(stream, { autoStart: true });`
Change to: `useContinuousRecording(stream, { autoStart: true, userId: user?.id });`

This ensures all uploads include the user's folder prefix when a user is logged in.
  </action>
  <verify>TypeScript compiles: `npm run build` succeeds. Manual test: log in, check network tab shows upload-url requests with user-prefixed filename.</verify>
  <done>CameraPreview passes user.id to continuous recording, uploads go to user-specific folders</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] TypeScript has no type errors
- [ ] uploadChunk function signature includes optional userId parameter
- [ ] useContinuousRecording accepts userId in options
- [ ] CameraPreview passes user.id to useContinuousRecording
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Cloud uploads will be organized as `formcheck/{userId}/{date}/{session}/chunk.webm`
- Backward compatible (works without userId for any edge cases)
</success_criteria>

<output>
After completion, create `.planning/phases/17-user-cloud-folders/17-01-SUMMARY.md`
</output>
